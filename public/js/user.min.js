$(function(){function send_request(){var e=null;return window.XMLHttpRequest?e=new XMLHttpRequest:window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),null!=e?(e.open("GET",serverUrl,!1),e.send(null),e.responseText):void alert("Your browser does not support XMLHTTP.")}function check_object_radio(){for(var e=document.getElementsByName("myradio"),t=0;t<e.length;t++)if(e[t].checked){g_object_name_type=e[t].value;break}}function get_signature(){if(now=timestamp=Date.parse(new Date)/1e3,expire<now+3){body=send_request();var obj=eval("("+body+")");return host=obj.host,policyBase64=obj.policy,accessid=obj.id,signature=obj.signature,expire=parseInt(obj.expire),callbackbody=obj.callback,key=obj.dir,!0}return!1}function random_string(e){e=e||32;var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=t.length,a="";for(i=0;i<e;i++)a+=t.charAt(Math.floor(Math.random()*n));return a}function get_suffix(e){return pos=e.lastIndexOf("."),suffix="",pos!=-1&&(suffix=e.substring(pos)),suffix}function calculate_object_name(e){return"local_name"==g_object_name_type?g_object_name+="${filename}":"random_name"==g_object_name_type&&(suffix=get_suffix(e),g_object_name=key+random_string(10)+suffix),""}function get_uploaded_object_name(e){return"local_name"==g_object_name_type?(tmp_name=g_object_name,tmp_name=tmp_name.replace("${filename}",e),tmp_name):"random_name"==g_object_name_type?g_object_name:void 0}function set_upload_param(e,t,n){0==n&&(n=get_signature()),g_object_name=key,""!=t&&(suffix=get_suffix(t),calculate_object_name(t)),new_multipart_params={key:g_object_name,policy:policyBase64,OSSAccessKeyId:accessid,success_action_status:"200",callback:callbackbody,signature:signature},e.setOption({url:host,multipart_params:new_multipart_params}),e.start()}var accessid="",accesskey="",host="",policyBase64="",signature="",callbackbody="",filename="",key="",expire=0,g_object_name="",g_object_name_type="",now=timestamp=Date.parse(new Date)/1e3,serverUrl="http://112.74.51.76:8888/video/prepare?callbackUrl=http://112.74.51.76:8888/video/callback",uploader=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:"change-avatar-btn",container:$(".avatar-set")[0],flash_swf_url:"lib/plupload-2.1.2/js/Moxie.swf",silverlight_xap_url:"lib/plupload-2.1.2/js/Moxie.xap",url:"http://oss.aliyuncs.com",filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,bmp"},{title:"Zip files",extensions:"zip,rar"}],max_file_size:"10mb",prevent_duplicates:!0},init:{PostInit:function(){document.getElementById("ossfile").innerHTML="",document.getElementById("start-upload-btn").onclick=function(){return set_upload_param(uploader,"",!1),!1}},FilesAdded:function(e,t){$(".upload-modal").modal("show"),plupload.each(t,function(e){document.getElementById("ossfile").innerHTML+='<div id="'+e.id+'">'+e.name+" ("+plupload.formatSize(e.size)+')<b></b><div class="progress"><div class="progress-bar" style="width: 0%"></div></div></div>'})},BeforeUpload:function(e,t){set_upload_param(e,t.name,!0)},UploadProgress:function(e,t){var n=document.getElementById(t.id);n.getElementsByTagName("b")[0].innerHTML="<span>"+t.percent+"%</span>";var a=n.getElementsByTagName("div")[0],o=a.getElementsByTagName("div")[0];o.style.width=2*t.percent+"px",o.setAttribute("aria-valuenow",t.percent)},FileUploaded:function(e,t,n){200==n.status?document.getElementById(t.id).getElementsByTagName("b")[0].innerHTML="upload to oss success, object name:"+get_uploaded_object_name(t.name)+" 回调服务器返回的内容是:"+n.response:203==n.status?document.getElementById(t.id).getElementsByTagName("b")[0].innerHTML="上传到OSS成功，但是oss访问用户设置的上传回调服务器失败，失败原因是:"+n.response:document.getElementById(t.id).getElementsByTagName("b")[0].innerHTML=n.response},Error:function(e,t){t.code==-600?console.log("\n选择的文件太大了,可以根据应用情况，在upload.js 设置一下上传的最大大小"):t.code==-601?console.log("\n选择的文件后缀不对,可以根据应用情况，在upload.js进行设置可允许的上传文件类型"):t.code==-602?console.log("\n这个文件已经上传过一遍了"):console.log("\nError xml:"+t.response)}}});uploader.init()});